var NotificationClient={sendSubscriptionToServer:function(a,b){var d=a.toJSON(),e="",f="",g=a.endpoint.split("/"),h=g[g.length-1];null!=d.keys&&(e=d.keys.auth,f=d.keys.p256dh);var i=!1,j=MMT_HEADER.getFromCache("notification");j&&null!=j?null!=j.subscription&&j.subscription.pushId==h&&j.subscription.auth==e&&j.subscription.p256dh==f||(i=!0):(j={},i=!0);var k=j.lastCall,l=(new Date).getTime();if((b||null==k||l-k>864e5)&&(j.lastCall=l,i=!0),i){j.subscription={pushId:h,auth:e,p256dh:f};var m=new Date("December 31, 2030 23:59:59");MMT_HEADER.putInCache("notification",j,m);var n=this.getBrowserDetails(),o=n.browserName,p=n.majorVersion,q="";navigator.appVersion.indexOf("Win")!=-1?q="Windows":navigator.appVersion.indexOf("Mac")!=-1?q="MacOS":navigator.appVersion.indexOf("X11")!=-1?q="UNIX":navigator.appVersion.indexOf("Linux")!=-1&&(q="Linux");for(var r=q+"|"+o+" "+n.fullVersion,s="",t=0;t<h.length;)s+=h.charAt(t),t+=4;var u=MMT_HEADER.getCookie("s_vi"),v={deviceId:s,pushId:h,auth:e,p256dh:f,deviceModel:r,browser:o,browserVersion:p,visitorId:u};v=JSON.stringify(v),MMT_HEADER.ajaxPost(MMT_HEADER.constants.notificationRegisterURL,v,NotificationClient.successAirpushRegister,NotificationClient.errorAirpushRegister)}},successAirpushRegister:function(a,b,c){a&&(a=JSON.parse(a),a&&200==a.responseCode)},errorAirpushRegister:function(a,b,c){},getBrowserDetails:function(){var e,f,g,a=navigator.userAgent,b=navigator.appName,c=""+parseFloat(navigator.appVersion),d=parseInt(navigator.appVersion,10);(f=a.indexOf("Opera"))!=-1?(b="Opera",c=a.substring(f+6),(f=a.indexOf("Version"))!=-1&&(c=a.substring(f+8))):(f=a.indexOf("MSIE"))!=-1?(b="Microsoft Internet Explorer",c=a.substring(f+5)):(f=a.indexOf("Chrome"))!=-1?(b="Chrome",c=a.substring(f+7)):(f=a.indexOf("Safari"))!=-1?(b="Safari",c=a.substring(f+7),(f=a.indexOf("Version"))!=-1&&(c=a.substring(f+8))):(f=a.indexOf("Firefox"))!=-1?(b="Firefox",c=a.substring(f+8)):(e=a.lastIndexOf(" ")+1)<(f=a.lastIndexOf("/"))&&(b=a.substring(e,f),c=a.substring(f+1),b.toLowerCase()==b.toUpperCase()&&(b=navigator.appName)),(g=c.indexOf(";"))!=-1&&(c=c.substring(0,g)),(g=c.indexOf(" "))!=-1&&(c=c.substring(0,g)),d=parseInt(""+c,10),isNaN(d)&&(c=""+parseFloat(navigator.appVersion),d=parseInt(navigator.appVersion,10));var h={browserName:b,fullVersion:c,majorVersion:d};return h},getSubscriptionAndRegister:function(a){if("1"!==router.getViewModel("header_info_view").data.displayNotifications)return void NotificationClient.disableNotifications();if("serviceWorker"in navigator&&"showNotification"in ServiceWorkerRegistration.prototype&&"denied"!==Notification.permission&&"PushManager"in window){var b=Notification.permission;navigator.serviceWorker.ready.then(function(c){c.pushManager.getSubscription().then(function(d){d?NotificationClient.sendSubscriptionToServer(d,a):c.pushManager.subscribe({userVisibleOnly:!0}).then(function(c){"default"===b&&NotificationClient.notificationOmnitureCall(null,"allow"),NotificationClient.sendSubscriptionToServer(c,a)}).catch(function(a){"denied"===Notification.permission?"default"===b&&NotificationClient.notificationOmnitureCall(null,"block"):"default"===Notification.permission&&"default"===b&&NotificationClient.notificationOmnitureCall(null,"cross")})}).catch(function(a){})})}},populateNotificationOverlay:function(){var a=router.getViewModel("header_info_view");if(("HLP"===a.data.lob||"HOMESTAY"===a.data.lob)&&"1"===a.data.displayNotifications){var b=MMT_HEADER.getFromCache("notification");b=NotificationClient.removeExpiredNotifications(b);var c=MMT_HEADER.getCookie("mmt-auth");if(null!=b){var d;if(c&&null!=c){d=new Array;var e=null==b.loginItems||0==b.loginItems.length,f=null==b.logoutItems||0==b.logoutItems.length;if(e&&f)d=null;else if(e&&!f)d=b.logoutItems;else if(!e&&f)d=b.loginItems;else{for(var g=0,h=0,i=0;g<3&&h<b.loginItems.length&&i<b.logoutItems.length;){var j=b.loginItems[h],k=b.logoutItems[i];j.time>k.time?(d[g++]=j,h++):(d[g++]=k,i++)}if(h==b.loginItems.length&&3!=g)for(;g<3;i++)d[g++]=b.logoutItems[i];if(i==b.logoutItems.length&&3!=g)for(;g<3;h++)d[g++]=b.loginItems[h]}}else d=b.logoutItems;var l=0;if(null!=d&&d.length>0){for(var h=0;h<d.length;h++)$("#notification_"+h+" #title").text(d[h].title),$("#notification_"+h+" #text").text(d[h].body),$("#notification_"+h).show(),$("#notification_"+h+" a").attr("href",d[h].webpageURL),d[h].highlight&&l++;for(var i=h;i<3;i++)$("#notification_"+i).hide();l>0?($(".ch__notificationCount").text(l),$(".ch__notificationCount").show()):$(".ch__notificationCount").hide()}else $(".ch__notificationCount").hide()}else $(".ch__notificationCount").hide()}},resetNewNotificationCount:function(){var a=MMT_HEADER.getFromCache("notification");if(null!=a){var b=!1,c=a.loginItems,d=a.logoutItems;if(null!=c&&c.length>0)for(var e=0;e<c.length;e++)c[e].highlight&&(c[e].highlight=!1,b=!0);if(null!=d&&d.length>0)for(var e=0;e<d.length;e++)d[e].highlight&&(d[e].highlight=!1,b=!0);if(a.loginItems=c,a.logoutItems=d,b){var f=new Date("December 31, 2030 23:59:59");MMT_HEADER.putInCache("notification",a,f)}}},removeExpiredNotifications:function(a){if(null!=a){var b=!1,c=a.loginItems,d=a.logoutItems;if(null!=c&&0!=c.length)for(var e=0;e<c.length;e++)try{var f=c[e].campaign,g=NotificationClient.getCampaignTime(f);if(null==g)continue;var h=(new Date).getTime();g<h&&(c.splice(e,1),e--,b=!0)}catch(a){}if(null!=d&&0!=d.length)for(var e=0;e<d.length;e++)try{var f=d[e].campaign,g=NotificationClient.getCampaignTime(f);if(null==g)continue;var h=(new Date).getTime();g<h&&(d.splice(e,1),e--,b=!0)}catch(a){}if(a.loginItems=c,a.logoutItems=d,b){var i=new Date("December 31, 2030 23:59:59");MMT_HEADER.putInCache("notification",a,i)}}return a},getCampaignTime:function(a){var b=a.lastIndexOf("_");if(b<0)return null;var c=a.substring(b+1);if(c.length<10||c.lastIndexOf("-")-c.indexOf("-")!=3)return null;var d=c.substring(0,c.indexOf("-")),e=c.substring(c.indexOf("-")+1,c.lastIndexOf("-")),f=c.substring(c.lastIndexOf("-")+1,c.indexOf(" ")),g="",h="",i="";c.indexOf(" ")<0||c.indexOf(":")<0?(g="00",h="00",i="00"):(g=c.substring(c.indexOf(" ")+1,c.indexOf(":")),c.indexOf(":")==c.lastIndexOf(":")?(h=c.substring(c.indexOf(":")+1),i="00"):(h=c.substring(c.indexOf(":")+1,c.lastIndexOf(":")),i=c.substring(c.lastIndexOf(":")+1)));var j=new Date(f,e-1,d,g,h,i,0);return j.getTime()},fetchNotificationFromServiceWorker:function(){return new Promise(function(a,b){var c=new MessageChannel;c.port1.onmessage=function(c){if(c.data.error)b(c.data.error);else{a(c.data);var d=c.data;if(null==d||0==d.length)return;for(var e=0;e<d.length;e++){var f=d[e];0==f.silent&&NotificationClient.saveNotification(f),f.clicked&&NotificationClient.notificationOmnitureCall(f,"click")}NotificationClient.populateNotificationOverlay()}},navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage("Requesting Notification From SW ",[c.port2])})},saveNotification:function(a){a.highlight=!0;var b=MMT_HEADER.getCookie("mmt-auth"),c=MMT_HEADER.getFromCache("notification");null==c&&(c={}),null==c.loginItems&&(c.loginItems=new Array),null==c.logoutItems&&(c.logoutItems=new Array);for(var d=0;d<3;d++)if(c.logoutItems[d]&&c.logoutItems[d].time==a.time||c.loginItems[d]&&c.loginItems[d].time==a.time)return;null!=b?(c.loginItems.unshift(a),4==c.loginItems.length&&(c.loginItems.length=3)):(c.logoutItems.unshift(a),4==c.logoutItems.length&&(c.logoutItems.length=3));var e=new Date("December 31, 2030 23:59:59");MMT_HEADER.putInCache("notification",c,e)},notificationOmnitureCall:function(a,b){var c=s_gi("mmtprod");if("click"==b){c.linkTrackVars="eVar0,eVar1,eVar39,eVar61,prop24",c.eVar0=a.campaign,c.eVar1=navigator.userAgent;var d=MMT_HEADER.getCookie("mmt-auth");d?c.eVar39="LoggedIn":c.eVar39="LoggedOut",c.eVar61="en",c.prop24="brand"}else{c.linkTrackVars="eVar1,eVar39,eVar61,prop54",c.eVar1=navigator.userAgent;var d=MMT_HEADER.getCookie("mmt-auth");d?c.eVar39="LoggedIn":c.eVar39="LoggedOut",c.eVar61="en","block"==b?c.prop54="System_popup_Block":"allow"==b?c.prop54="System_popup_Allow":"cross"==b&&(c.prop54="System_popup_Cross")}c.tl()},disableNotifications:function(){$(".notification_dropdown").hide(),$("#ch_notification").hide(),$("[data-overlay-open=my-trip-login]").css("right","98px"),$("[data-overlay-open=my-trip-trips]").css("right","179px"),$("[data-overlay-open=my-trip-empty]").css("right","179px"),$("[data-overlay-open=walletMenu_balance]").css("right","135px"),$("[data-overlay-open=walletMenu_empty]").css("right","135px")},registerServiceWorker:function(){router.getViewModel("header_info_view")&&router.getViewModel("header_info_view").data&&"1"===router.getViewModel("header_info_view").data.displayNotifications?"serviceWorker"in navigator&&(navigator.serviceWorker.register("/sw-mmt.js").then(function(a){NotificationClient.getSubscriptionAndRegister(!1),NotificationClient.fetchNotificationFromServiceWorker()}).catch(function(a){}),navigator.serviceWorker.addEventListener("message",function(a){null!=a.data&&(a.data.clicked&&NotificationClient.notificationOmnitureCall(a.data,"click"),a.data.silent||(NotificationClient.saveNotification(a.data),NotificationClient.populateNotificationOverlay()))})):NotificationClient.disableNotifications()}};$(window).load(function(){NotificationClient.registerServiceWorker(),NotificationClient.populateNotificationOverlay()});